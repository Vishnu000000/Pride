<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Mute Timer</title>
<style>
body{margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;
background:#0b1220;color:#e5eef8;font-family:system-ui}
.card{background:#0f172a;padding:24px;border-radius:14px;width:360px;text-align:center}
.number{font-size:2.2rem;font-weight:700;margin:10px 0}
.small{color:#94a3b8;font-size:.85rem}
button,input{width:100%;margin-top:8px;padding:10px;border-radius:8px;border:none}
.admin{margin-top:12px;color:#7dd3fc;cursor:pointer;font-size:.85rem}
</style>
</head>
<body>

<div class="card">
  <h2 id="person">someone</h2>
  <div class="number" id="time">0d 0h 0m 0s</div>
  <div class="small" id="end"></div>

  <div class="admin" onclick="toggle()">admin</div>

  <div id="controls" style="display:none">
    <input id="secret" type="password" placeholder="Secret">
    <button onclick="addDay()">+1 day</button>
    <button onclick="doubleTime()">Ã—2 time</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
/* ===== CONFIG ===== */
const firebaseConfig = {
  apiKey: "AIzaSyBLWQNTIC68JPrr1wkKSyzYpmc_9waVo3E",
  authDomain: "mute-counter.firebaseapp.com",
  projectId: "mute-counter",
  storageBucket: "mute-counter.firebasestorage.app",
  messagingSenderId: "1097181150070",
  appId: "1:1097181150070:web:56330e7781af0ab5d61857"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const ref = db.collection("config").doc("state");

/* ===== HELPERS ===== */
const DAY = 86400000;

async function sha256(t){
  const b = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(t));
  return [...new Uint8Array(b)].map(x=>x.toString(16).padStart(2,"0")).join("");
}

function fmt(ms){
  ms=Math.max(0,ms);
  const d=Math.floor(ms/DAY); ms%=DAY;
  const h=Math.floor(ms/3600000); ms%=3600000;
  const m=Math.floor(ms/60000); ms%=60000;
  const s=Math.floor(ms/1000);
  return `${d}d ${h}h ${m}m ${s}s`;
}

/* ===== CORE ===== */
let state;

async function load(){
  const snap=await ref.get();
  state=snap.data();

  const now=Date.now();
  const diff=now-state.lastUpdated;
  state.remainingMs=Math.max(0,state.remainingMs-diff);
  state.lastUpdated=now;

  await ref.update({
    remainingMs: state.remainingMs,
    lastUpdated: now
  });

  document.getElementById("person").textContent=state.person;
  tick();
}

function tick(){
  document.getElementById("time").textContent=fmt(state.remainingMs);
  setTimeout(()=>{
    state.remainingMs-=1000;
    tick();
  },1000);
}

/* ===== ADMIN ===== */
function toggle(){
  document.getElementById("controls").style.display="block";
}

async function auth(){
  const s=document.getElementById("secret").value;
  if(!s) throw "No secret";
  const h=await sha256(s);
  if(h!==state.secretHash) throw "Wrong secret";
}

async function addDay(){
  try{
    await auth();
    state.remainingMs+=DAY;
    state.lastUpdated=Date.now();
    await ref.update(state);
  }catch(e){alert(e);}
}

async function doubleTime(){
  try{
    await auth();
    state.remainingMs*=2;
    state.lastUpdated=Date.now();
    await ref.update(state);
  }catch(e){alert(e);}
}

/* ===== START ===== */
load();
</script>

</body>
</html>
